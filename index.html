<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Detection Duration by Facility</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #filters {
      text-align: center;
      margin-bottom: 1rem;
    }
    #filters label {
      margin: 0 1rem;
    }
    .loading, .error {
      text-align: center;
      margin-top: 2rem;
    }
    .error {
      color: red;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
    }
    th {
      background: #f0f0f0;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Facilities by 30‑Day Detection Duration</h1>

  <div id="filters">
    <label>
      Country:
      <input type="text" id="country-filter" placeholder="e.g. USA">
    </label>
    <label>
      Software Slug:
      <input type="text" id="slug-filter" placeholder="e.g. coldos_sense">
    </label>
    <button id="apply-filters">Apply Filters</button>
  </div>

  <div id="loading" class="loading" style="display:none;">Loading data…</div>
  <div id="error" class="error" style="display:none;"></div>

  <table id="report" style="display:none;">
    <thead>
      <tr>
        <th>Facility</th>
        <th>Total Duration (days)</th>
        <th>Monitor Count</th>
        <th>Severity Breakdown</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    (async () => {
      const loadingEl = document.getElementById('loading');
      const errorEl   = document.getElementById('error');
      const reportEl  = document.getElementById('report');
      const tbody     = reportEl.querySelector('tbody');
      const btn       = document.getElementById('apply-filters');
      const countryInput = document.getElementById('country-filter');
      const slugInput    = document.getElementById('slug-filter');

      const severityLabels = { '1': 'minor', '2': 'major' };

      async function fetchAndRender() {
        loadingEl.style.display = '';
        errorEl.style.display = 'none';
        reportEl.style.display = 'none';
        tbody.innerHTML = '';

        const countryFilter = countryInput.value.trim();
        const slugFilter    = slugInput.value.trim();

        const query = `
          query($monitorsFilter2: MonitorFilter) {
            monitors(filter: $monitorsFilter2) {
              nodes {
                name
                thirtyDayDetectionDurationSeconds
                check {
                  severity {
                    value
                  }
                }
                facilityNames
                facilities {
                  nodes { country }
                }
                softwarePackageSlugs
              }
            }
          }`;
        const variables = {
          monitorsFilter2: {
            thirtyDayDetectionDurationSeconds: { greaterThan: 604800 },
            isEnabled: { equalTo: true }
          }
        };

        try {
          const res = await fetch('https://cp-alert-signoff-proxy.onrender.com/lineage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, variables })
          });
          if (!res.ok) throw new Error(`Network error: ${res.status}`);
          const { data } = await res.json();

          // filter by country & slug
          const filtered = data.monitors.nodes.filter(node => {
            const countries = (node.facilities.nodes || []).map(f => f.country);
            const okCountry = !countryFilter || countries.includes(countryFilter);
            const okSlug    = !slugFilter || node.softwarePackageSlugs.includes(slugFilter);
            return okCountry && okSlug;
          });

          // group by facilityNames
          const facilities = {};
          filtered.forEach(node => {
            const secs = node.thirtyDayDetectionDurationSeconds;
            const sev  = String(node.check?.severity?.value || '');
            const rawNames = node.facilityNames;
            const namesList = rawNames == null
              ? []
              : Array.isArray(rawNames)
                ? rawNames
                : [rawNames];
            namesList.forEach(fac => {
              if (!fac) return;
              if (!facilities[fac]) {
                facilities[fac] = { totalSec: 0, count: 0, severity: {} };
              }
              facilities[fac].totalSec += secs;
              facilities[fac].count    += 1;
              const label = severityLabels[sev] || sev;
              facilities[fac].severity[label] = (facilities[fac].severity[label] || 0) + 1;
            });
          });

          const rows = Object.entries(facilities)
            .map(([name, stats]) => ({
              name,
              totalDays: (stats.totalSec / 86400).toFixed(2),
              count: stats.count,
              severity: stats.severity
            }))
            .sort((a, b) => b.totalDays - a.totalDays);

          rows.forEach(({ name, totalDays, count, severity }) => {
            const tr = document.createElement('tr');
            const sevBreak = Object.entries(severity)
              .map(([sev, cnt]) => `${sev}: ${cnt}`)
              .join(', ');
            tr.innerHTML = `
              <td>${name}</td>
              <td>${totalDays}</td>
              <td>${count}</td>
              <td>${sevBreak}</td>
            `;
            tbody.appendChild(tr);
          });

          loadingEl.style.display = 'none';
          reportEl.style.display  = 'table';
        } catch (err) {
          console.error(err);
          loadingEl.style.display = 'none';
          errorEl.textContent = `Error loading data: ${err.message}`;
          errorEl.style.display = '';
        }
      }

      btn.addEventListener('click', fetchAndRender);
      // initial load
      fetchAndRender();
    })();
  </script>
</body>
</html>
