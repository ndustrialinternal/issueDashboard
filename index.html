<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Detection Duration Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    h1 { text-align: center; margin-bottom: 1rem; }

    /* Filters */
    #filters { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    #filters label { display: flex; flex-direction: column; font-size: 0.9rem; }
    #filters select, #filters button { margin-top: 0.5rem; padding: 0.4rem; font-size: 1rem; }

    /* Loading & error */
    .loading, .error { text-align: center; margin-top: 2rem; }
    .error { color: red; }

    /* Main table */
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    th { background: #f0f0f0; text-align: left; }
    td a.facility-link { color: #007bff; cursor: pointer; text-decoration: underline; }

    /* Modal */
    #modal-overlay {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
      z-index: 1000;
    }
    #modal {
      background: #fff;
      padding: 1rem;
      border-radius: 4px;
      max-width: 500px; width: 90%;
      max-height: 80vh; overflow-y: auto;
    }
    #modal h2 { margin-top: 0; }
    #modal table { width: 100%; margin-top: 0.5rem; }
    #modal-close { float: right; cursor: pointer; font-size: 1.2rem; border: none; background: none; }
  </style>
</head>
<body>
  <h1>Detection Duration Dashboard</h1>

  <!-- Filters -->
  <div id="filters">
    <label>
      Country
      <select id="country-filter"><option value="">All</option></select>
    </label>
    <label>
      Software Slug
      <select id="slug-filter"><option value="">All</option></select>
    </label>
    <button id="apply-filters">Apply Filters</button>
  </div>

  <!-- Status -->
  <div id="loading" class="loading">Loading data…</div>
  <div id="error" class="error" style="display:none;"></div>

  <!-- Report -->
  <table id="report" style="display:none;">
    <thead>
      <tr>
        <th>Facility</th>
        <th>Total Duration (days)</th>
        <th>Monitor Count</th>
        <th>Severity Breakdown</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal -->
  <div id="modal-overlay">
    <div id="modal">
      <button id="modal-close">&times;</button>
      <h2 id="modal-title"></h2>
      <div id="modal-loading">Loading…</div>
      <div id="modal-error" class="error" style="display:none;"></div>
      <table id="modal-table" style="display:none;">
        <thead>
          <tr>
            <th>Check Name</th>
            <th>Total Duration (days)</th>
            <th>Monitor Count</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  (function(){
    // DOM refs
    const countrySelect = document.getElementById('country-filter');
    const slugSelect    = document.getElementById('slug-filter');
    const applyBtn      = document.getElementById('apply-filters');
    const loadingEl     = document.getElementById('loading');
    const errorEl       = document.getElementById('error');
    const reportEl      = document.getElementById('report');
    const tbody         = reportEl.querySelector('tbody');

    const modalOverlay  = document.getElementById('modal-overlay');
    const modalClose    = document.getElementById('modal-close');
    const modalTitle    = document.getElementById('modal-title');
    const modalLoad     = document.getElementById('modal-loading');
    const modalErr      = document.getElementById('modal-error');
    const modalTable    = document.getElementById('modal-table');
    const modalTbody    = modalTable.querySelector('tbody');

    // Map raw severity values to labels; 'unknown' fallback
    const severityLabels = { '1': 'minor', '2': 'major', 'unknown': 'unknown' };
    let monitors = [];

    // 1) Initial fetch of monitors
    (async function(){
      try {
        const query = "\
          query($monitorsFilter2: MonitorFilter){\
            monitors(filter:$monitorsFilter2){\
              nodes{\
                name\
                thirtyDayDetectionDurationSeconds\
                check{name severity{value}}\
                facilityNames\
                facilities{nodes{country}}\
                softwarePackageSlugs\
              }\
            }\
          }";
        const variables = {
          monitorsFilter2: {
            thirtyDayDetectionDurationSeconds: { greaterThan: 604800 },
            isEnabled: { equalTo: true }
          }
        };
        const res = await fetch('https://cp-alert-signoff-proxy.onrender.com/lineage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query, variables: variables })
        });
        if (!res.ok) throw new Error('Status ' + res.status);
        const json = await res.json();
        monitors = json.data.monitors.nodes;

        populateFilters();
        renderReport();
      } catch(err) {
        loadingEl.style.display = 'none';
        errorEl.textContent = 'Error loading data: ' + err.message;
        errorEl.style.display = '';
      }
    })();

    // 2) Build filter dropdowns
    function populateFilters(){
      const countries = new Set(), slugs = new Set();
      monitors.forEach(function(n){
        // Collect country from each facility
        (n.facilities.nodes || []).forEach(function(f){
          if (f.country) countries.add(f.country);
        });
        // Collect software slugs
        (n.softwarePackageSlugs || []).forEach(function(s){
          if (s) slugs.add(s);
        });
      });
      countries.forEach(function(c){
        countrySelect.appendChild(new Option(c, c));
      });
      slugs.forEach(function(s){
        slugSelect.appendChild(new Option(s, s));
      });
      // Hide loading spinner once filters ready
      loadingEl.style.display = 'none';
    }

    // 3) Re-render on filter change
    applyBtn.addEventListener('click', renderReport);

    // 4) Main rendering of the report table
    function renderReport(){
      // clear previous
      tbody.innerHTML = '';
      errorEl.style.display = 'none';
      reportEl.style.display = 'none';

      const cf = countrySelect.value, sf = slugSelect.value;
      // filter monitors by country & slug
      const filtered = monitors.filter(function(n){
        const countries = (n.facilities.nodes || []).map(function(f){ return f.country; });
        return (!cf || countries.includes(cf)) &&
               (!sf || n.softwarePackageSlugs.includes(sf));
      });

      // group by facility name
      const facMap = {};
      filtered.forEach(function(n){
        const secs = n.thirtyDayDetectionDurationSeconds;
        // Safely read severity: default to 'unknown'
        const rawSeverity = n.check?.severity?.value ?? 'unknown';
        const sevKey = String(rawSeverity);
        // Wrap facilityNames as array
        const names = n.facilityNames == null
          ? []
          : Array.isArray(n.facilityNames)
            ? n.facilityNames
            : [n.facilityNames];
        names.forEach(function(fac){
          if (!fac) return;
          if (!facMap[fac]) {
            facMap[fac] = { totalSec: 0, count: 0, severity: {}, monitors: [] };
          }
          facMap[fac].totalSec += secs;
          facMap[fac].count++;
          facMap[fac].monitors.push(n);
          const label = severityLabels[sevKey] || 'unknown';
          facMap[fac].severity[label] = (facMap[fac].severity[label] || 0) + 1;
        });
      });

      // convert to sorted array
      const rows = Object.entries(facMap).map(function(entry){
        const name = entry[0], st = entry[1];
        return {
          name: name,
          totalDays: (st.totalSec / 86400).toFixed(2),
          count: st.count,
          severity: st.severity,
          monitors: st.monitors
        };
      }).sort(function(a,b){
        return b.totalDays - a.totalDays;
      });

      if (!rows.length) {
        errorEl.textContent = 'No data matches the selected filters.';
        errorEl.style.display = '';
        return;
      }

      // populate table rows and attach modal handlers
      rows.forEach(function(r){
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td><a class="facility-link">' + r.name + '</a></td>' +
          '<td>' + r.totalDays + '</td>' +
          '<td>' + r.count + '</td>' +
          '<td>' + Object.entries(r.severity).map(function(pair){
            return pair[0] + ': ' + pair[1];
          }).join(', ') + '</td>';
        tr.querySelector('.facility-link').addEventListener('click', function(){
          openModal(r.name, r.monitors);
        });
        tbody.appendChild(tr);
      });

      reportEl.style.display = 'table';
    }

    // 5) Modal logic: show breakdown by check name
    function openModal(name, monList){
      modalTitle.textContent = name;
      modalTbody.innerHTML = '';
      modalErr.style.display = 'none';
      modalTable.style.display = 'none';
      modalLoad.style.display = '';
      modalOverlay.style.display = 'flex';

      // group by check.name
      const map = {};
      monList.forEach(function(n){
        const chk = n.check.name;
        const secs = n.thirtyDayDetectionDurationSeconds;
        if (!map[chk]) map[chk] = { totalSec: 0, count: 0 };
        map[chk].totalSec += secs;
        map[chk].count++;
      });

      // populate modal table
      Object.entries(map).forEach(function(entry){
        const chk = entry[0], st = entry[1];
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + chk + '</td>' +
          '<td>' + (st.totalSec / 86400).toFixed(2) + '</td>' +
          '<td>' + st.count + '</td>';
        modalTbody.appendChild(tr);
      });

      modalLoad.style.display = 'none';
      modalTable.style.display = 'table';
    }

    // close modal
    document.getElementById('modal-close').addEventListener('click', function(){
      document.getElementById('modal-overlay').style.display = 'none';
    });
  })();
  </script>
</body>
</html>
